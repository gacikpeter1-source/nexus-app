rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    /* ===========================
       HELPER FUNCTIONS
       =========================== */
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is club owner (creator or in trainers array)
    function isClubOwner(clubId) {
      let club = get(/databases/$(database)/documents/clubs/$(clubId)).data;
      return isAuthenticated() && (
        club.createdBy == request.auth.uid ||
        request.auth.uid in club.trainers
      );
    }
    
    // Check if user is club member
    function isClubMember(clubId) {
      let club = get(/databases/$(database)/documents/clubs/$(clubId)).data;
      return isAuthenticated() && (
        club.ownerId == request.auth.uid ||
        request.auth.uid in club.members ||
        request.auth.uid in club.trainers ||
        request.auth.uid in club.assistants
      );
    }
    
    // Check if user is club trainer
    function isClubTrainer(clubId) {
      let club = get(/databases/$(database)/documents/clubs/$(clubId)).data;
      return isAuthenticated() && request.auth.uid in club.trainers;
    }
    
    // Check if user is team member
    function isTeamMember(clubId, teamId) {
      let club = get(/databases/$(database)/documents/clubs/$(clubId)).data;
      let teams = club.teams;
      
      // Find the team in the club's teams array
      return isAuthenticated() && (
        isClubOwner(clubId) ||
        teams.hasAny([teamId]) && (
          request.auth.uid in teams[teamId].members ||
          request.auth.uid in teams[teamId].trainers ||
          request.auth.uid in teams[teamId].assistants
        )
      );
    }
    
    // Check if user has active subscription
    function hasActiveSubscription(userId) {
      let user = get(/databases/$(database)/documents/users/$(userId)).data;
      return user.subscriptionStatus == 'active' || user.subscriptionStatus == 'trial';
    }
    
    /* ===========================
       USERS COLLECTION
       =========================== */
    
    match /users/{userId} {
      // Anyone can create their own user document during registration
      // Parents can also create child subaccounts
      allow create: if isOwner(userId) || 
        (isAuthenticated() && 
         'managedByParentId' in request.resource.data && 
         request.resource.data.managedByParentId == request.auth.uid);
      
      // Authenticated users can read other users' profiles (for chat, team lists, etc.)
      // Users can read their own data, admins can read all
      allow read: if isAuthenticated();
      
      // Users can update their own profile, admins can update any
      // Parents can update their child subaccounts
      // ✅ FIX: Club owners/trainers can update clubIds when approving join requests
      // ✅ FIX: Club owners/trainers can update role field (to assign parent role)
      allow update: if isOwner(userId) || isAdmin() ||
        (isAuthenticated() && 
         'managedByParentId' in resource.data && 
         resource.data.managedByParentId == request.auth.uid) ||
        // Allow club owners/trainers to update clubIds only (for join request approval)
        (isAuthenticated() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['clubIds', 'updatedAt'])) ||
        // Allow club owners/trainers to update role field (e.g., assign parent role)
        // Restrict to non-admin roles for security
        (isAuthenticated() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role', 'updatedAt']) &&
         request.resource.data.role in ['user', 'parent', 'trainer', 'assistant']);
      
      // Users can delete their own account, admins can delete any (except other admins)
      // Parents can delete child subaccounts
      allow delete: if isOwner(userId) || 
        (isAdmin() && !get(/databases/$(database)/documents/users/$(userId)).data.isSuperAdmin) ||
        (isAuthenticated() && 
         'managedByParentId' in resource.data && 
         resource.data.managedByParentId == request.auth.uid);
      
      /* User Settings Subcollection */
      match /settings/{settingId} {
        // Users can read and write their own settings
        allow read, write: if isOwner(userId);
        
        // Admins can read any user's settings (for debugging)
        allow read: if isAdmin();
      }
    }
    
    /* ===========================
       CLUBS COLLECTION
       =========================== */
    
    match /clubs/{clubId} {
      // ✅ FIX: Allow authenticated users to create clubs
      // (Subscription validation handled in app logic to avoid circular dependencies)
      allow create: if isAuthenticated();
      
      // All authenticated users can read clubs (for browsing, joining, chat creation)
      // This is safe because sensitive operations (update/delete) still require ownership
      allow read: if isAuthenticated();
      
      // ✅ FIX: Allow club owners and trainers to update
      // (Subscription validation handled in app logic)
      // ✅ ALSO allow members to remove themselves (Leave Club functionality)
      // ✅ ALSO allow team members to remove themselves from teams (Leave Team functionality)
      allow update: if isAuthenticated() && (
        isAdmin() || 
        isClubOwner(clubId) || 
        isClubTrainer(clubId) ||
        // Allow user to remove themselves from club (Leave Club)
        // User must be currently in the club AND removing themselves from members/trainers/assistants/teams
        ((request.auth.uid in resource.data.members || 
          request.auth.uid in resource.data.trainers || 
          request.auth.uid in resource.data.assistants) &&
         !(request.auth.uid in request.resource.data.members) &&
         !(request.auth.uid in request.resource.data.trainers) &&
         !(request.auth.uid in request.resource.data.assistants)) ||
        // Allow user to update only teams array (Leave Team functionality)
        // This allows removing oneself from a team within the club
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['teams', 'updatedAt']))
      );
      
      // Only club owners, trainers, or admins can delete clubs
      allow delete: if isAdmin() || isClubOwner(clubId) || isClubTrainer(clubId);
      
      // ✅ Club-level notification settings
      match /notificationSettings/{settingId} {
        // ✅ FIX: Allow authenticated users to read settings (for queries)
        allow read: if isAuthenticated();
        
        // Only club owners and trainers can update settings
        allow write: if isAuthenticated() && (
          isAdmin() ||
          isClubOwner(clubId) ||
          isClubTrainer(clubId)
        );
      }
      
      // ✅ Team-level notification settings (nested)
      match /teams/{teamId}/notificationSettings/{settingId} {
        // ✅ FIX: Allow authenticated users to read settings (for queries)
        allow read: if isAuthenticated();
        
        // Only club owners and trainers can update settings
        allow write: if isAuthenticated() && (
          isAdmin() ||
          isClubOwner(clubId) ||
          isClubTrainer(clubId)
        );
      }
    }
    
    /* ===========================
       EVENTS COLLECTION
       =========================== */
    
    match /events/{eventId} {
      // Authenticated users can create events (personal events)
      // Club/team events require appropriate permissions (checked in app logic)
      allow create: if isAuthenticated();
      
      // All authenticated users can read events (for calendar display and discovery)
      // Sensitive operations (create/update/delete) are still protected
      allow read: if isAuthenticated();
      
      // ✅ FIX: Allow updates for:
      // 1. Users updating RSVP (responses field only)
      // 2. Event creators, club owners, trainers (full updates)
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        (resource.data.visibilityLevel == 'club' && resource.data.clubId != null && isClubOwner(resource.data.clubId)) ||
        (resource.data.visibilityLevel == 'team' && resource.data.clubId != null && isClubTrainer(resource.data.clubId)) ||
        // ✅ Allow any authenticated user to update responses (RSVP)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['responses', 'updatedAt', 'waitlist', 'confirmedCount'])
      );
      
      // Same permissions for delete as update
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        (resource.data.visibilityLevel == 'club' && resource.data.clubId != null && isClubOwner(resource.data.clubId)) ||
        (resource.data.visibilityLevel == 'team' && resource.data.clubId != null && isClubTrainer(resource.data.clubId))
      );
    }
    
    /* ===========================
       CHATS COLLECTION
       =========================== */
    
    match /chats/{chatId} {
      // Authenticated users can create chats
      allow create: if isAuthenticated();
      
      // ✅ FIX: Allow authenticated users to read chats (for queries)
      // App logic will filter to show only user's chats
      allow read: if isAuthenticated();
      
      // Only members can update chat
      allow update: if isAuthenticated() && (
        isAdmin() ||
        request.auth.uid in resource.data.members
      );
      
      // Only admins or chat creators can delete chats
      allow delete: if isAdmin() || resource.data.createdBy == request.auth.uid;
      
      /* Messages Subcollection */
      match /messages/{messageId} {
        // ✅ FIX: Allow authenticated users to create/read messages
        // Parent chat read permissions control access
        allow create: if isAuthenticated();
        
        // Allow authenticated users to read messages
        allow read: if isAuthenticated();
        
        // Message sender can update their own message
        allow update: if isAuthenticated() && resource.data.senderId == request.auth.uid;
        
        // Message sender or admin can delete message
        allow delete: if isAdmin() || resource.data.senderId == request.auth.uid;
      }
    }
    
    /* ===========================
       REQUESTS COLLECTION
       =========================== */
    
    match /requests/{requestId} {
      // Authenticated users can create requests
      allow create: if isAuthenticated();
      
      // ✅ FIX: Allow list/query operations for trainers to see pending requests
      // This is needed for getPendingRequests() function in PendingRequests page
      allow list: if isAuthenticated();
      
      // Request creator and club owners/trainers can read individual documents
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid ||
        isClubOwner(resource.data.clubId) ||
        isClubTrainer(resource.data.clubId)
      );
      
      // Club owners and trainers can update requests (approve/reject)
      allow update: if isAuthenticated() && (
        isAdmin() ||
        isClubOwner(resource.data.clubId) ||
        isClubTrainer(resource.data.clubId)
      );
      
      // Request creator, club owner, or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid ||
        isClubOwner(resource.data.clubId)
      );
    }
    
    /* ===========================
       ORDER TEMPLATES COLLECTION
       =========================== */
    
    match /orderTemplates/{orderId} {
      // Club owners and trainers can create order templates
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isClubOwner(request.resource.data.clubId) ||
        isClubTrainer(request.resource.data.clubId)
      );
      
      // Club members can read orders
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isClubMember(resource.data.clubId)
      );
      
      // Creator, club owner, or trainers can update
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        isClubOwner(resource.data.clubId) ||
        isClubTrainer(resource.data.clubId)
      );
      
      // Creator, club owner, or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        isClubOwner(resource.data.clubId)
      );
    }
    
    /* ===========================
       ORDER RESPONSES COLLECTION
       =========================== */
    
    match /orderResponses/{responseId} {
      // ✅ FIX: Allow authenticated users to create order responses
      // (Club membership validated in app logic)
      allow create: if isAuthenticated();
      
      // ✅ FIX: Allow authenticated users to read order responses
      // (Needed for team queries, app filters by user's teams)
      allow read: if isAuthenticated();
      
      // Response owner can update their own response
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Response owner or admin can delete
      allow delete: if isAdmin() || resource.data.userId == request.auth.uid;
    }
    
    /* ===========================
       ATTENDANCE COLLECTION
       =========================== */
    
    match /attendance/{attendanceId} {
      // Trainers and assistants can create attendance
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isClubOwner(request.resource.data.clubId) ||
        isClubTrainer(request.resource.data.clubId)
      );
      
      // ✅ FIX: Allow authenticated users to read attendance
      // (Team members need to see attendance for their teams, app filters by team)
      allow read: if isAuthenticated();
      
      // Trainers and assistants can update attendance
      allow update: if isAuthenticated() && (
        isAdmin() ||
        isClubOwner(resource.data.clubId) ||
        isClubTrainer(resource.data.clubId)
      );
      
      // Creator or admin can delete
      allow delete: if isAdmin() || resource.data.createdBy == request.auth.uid;
    }
    
    /* ===========================
       SUBSCRIPTIONS COLLECTION
       =========================== */
    
    match /subscriptions/{subscriptionId} {
      // Only admins or the subscription owner can create
      allow create: if isAdmin() || isOwner(request.resource.data.userId);
      
      // ✅ FIX: Allow all authenticated users to read subscriptions
      // (Needed for ClubsDashboard to check club subscription status)
      // Subscription status is not sensitive data
      allow read: if isAuthenticated();
      
      // Only admins can update subscriptions
      allow update: if isAdmin();
      
      // Only admins can delete subscriptions
      allow delete: if isAdmin();
    }
    
    /* ===========================
       INVOICES COLLECTION
       =========================== */
    
    match /invoices/{invoiceId} {
      // Only admins can create invoices
      allow create: if isAdmin();
      
      // User can read their own invoices, admins can read all
      allow read: if isAdmin() || isOwner(resource.data.userId);
      
      // Only admins can update invoices
      allow update: if isAdmin();
      
      // Only admins can delete invoices
      allow delete: if isAdmin();
    }
    
    /* ===========================
       VOUCHERS COLLECTION
       =========================== */
    
    match /vouchers/{voucherId} {
      // Only admins can create vouchers
      allow create: if isAdmin();
      
      // Everyone can read vouchers (to validate codes)
      allow read: if isAuthenticated();
      
      // Only admins can update vouchers
      allow update: if isAdmin();
      
      // Only admins can delete vouchers
      allow delete: if isAdmin();
    }
    
    /* ===========================
       AUDIT LOGS COLLECTION
       =========================== */
    
    match /auditLogs/{logId} {
      // System can create audit logs (backend function)
      allow create: if true;
      
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // Audit logs are immutable (cannot be updated)
      allow update: if false;
      
      // Only admins can delete audit logs (for cleanup)
      allow delete: if isAdmin();
    }
    
    /* ===========================
       PRIVILEGES COLLECTION
       =========================== */
    
    match /privileges/{userId} {
      // Only admins can create privilege documents
      allow create: if isAdmin();
      
      // User can read their own privileges, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Only admins can update privileges
      allow update: if isAdmin();
      
      // Only admins can delete privileges
      allow delete: if isAdmin();
    }
    
    /* ===========================
       EMAIL QUEUE COLLECTION
       =========================== */
    
    match /emailQueue/{emailId} {
      // System and admins can create email queue items
      allow create: if isAuthenticated();
      
      // Only admins can read email queue
      allow read: if isAdmin();
      
      // System updates email status
      allow update: if true;
      
      // Only admins can delete email queue items
      allow delete: if isAdmin();
    }
    
    /* ===========================
       PENDING NOTIFICATIONS COLLECTION (Waitlist only)
       =========================== */
    
    match /pendingNotifications/{notificationId} {
      // System can create notifications
      allow create: if isAuthenticated();
      
      // User can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // System can update notifications
      allow update: if true;
      
      // User can delete their own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    /* ===========================
       IN-APP NOTIFICATIONS COLLECTION (New)
       =========================== */
    
    match /notifications/{notificationId} {
      // System and authenticated users can create notifications
      allow create: if isAuthenticated();
      
      // Users can list/query their own notifications
      allow list: if isAuthenticated() && request.auth.uid != null;
      
      // Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can update (mark as read) their own notifications
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    /* ===========================
       SUBSTITUTION REQUESTS (Phase 4a)
       =========================== */
    
    match /substitutionRequests/{requestId} {
      // Cloud Functions can create
      allow create: if isAuthenticated();
      
      // User can read requests where they are involved (original or substitute)
      allow read: if isAuthenticated() && (
        resource.data.originalUserId == request.auth.uid ||
        resource.data.substituteUserId == request.auth.uid ||
        isAdmin()
      );
      
      // Cloud Functions can update
      allow update: if isAuthenticated();
      
      // Cloud Functions can delete
      allow delete: if isAuthenticated();
    }
    
    /* ===========================
       SCHEDULED REMINDERS (Phase 2)
       =========================== */
    
    match /scheduledReminders/{reminderId} {
      // Cloud Functions create reminders
      allow create: if isAuthenticated();
      
      // Users can read their own reminders
      allow read: if isAuthenticated();
      
      // Cloud Functions update/delete
      allow update, delete: if isAuthenticated();
    }
    
    /* ===========================
       SCHEDULED LOCK NOTIFICATIONS (Phase 4b)
       =========================== */
    
    match /scheduledLockNotifications/{lockNotificationId} {
      // Cloud Functions create lock notifications
      allow create: if isAuthenticated();
      
      // Users can read lock notifications
      allow read: if isAuthenticated();
      
      // Cloud Functions update/delete
      allow update, delete: if isAuthenticated();
    }
    
    /* ===========================
       TRAINING LIBRARY
       =========================== */
    
    match /trainings/{trainingId} {
      // Any authenticated user can create trainings (they will own them)
      allow create: if isAuthenticated() && 
                      request.resource.data.ownerId == request.auth.uid;
      
      // Users can read their own trainings
      allow read: if isAuthenticated() && 
                    resource.data.ownerId == request.auth.uid;
      
      // Users can update their own trainings
      allow update: if isAuthenticated() && 
                      resource.data.ownerId == request.auth.uid;
      
      // Users can delete their own trainings
      allow delete: if isAuthenticated() && 
                      resource.data.ownerId == request.auth.uid;
    }
    
    /* ===========================
       PARENT-CHILD RELATIONSHIPS
       =========================== */
    
    match /parentChildRelationships/{relationshipId} {
      // Parents and children can read their relationships
      // For additional_parent requests, both the new parent and requesting parent can read
      allow read: if isAuthenticated() && 
        (resource.data.parentId == request.auth.uid || 
         resource.data.childId == request.auth.uid ||
         (resource.data.keys().hasAny(['requestedByParentId']) && 
          resource.data.requestedByParentId == request.auth.uid));
      
      // Allow list/query operations for authenticated users
      // (Individual document access is still controlled by read rule above)
      allow list: if isAuthenticated();
      
      // Parents can create relationships
      // For additional_parent: existing parent can create link for new parent
      allow create: if isAuthenticated() && 
        (request.resource.data.parentId == request.auth.uid ||
         (request.resource.data.keys().hasAny(['requestedByParentId']) && 
          request.resource.data.requestedByParentId == request.auth.uid));
      
      // Involved parties can update (for approval)
      allow update: if isAuthenticated() && 
        (resource.data.parentId == request.auth.uid || 
         resource.data.childId == request.auth.uid ||
         (resource.data.keys().hasAny(['requestedByParentId']) && 
          resource.data.requestedByParentId == request.auth.uid));
      
      // Parents can delete their relationships
      allow delete: if isAuthenticated() && 
        resource.data.parentId == request.auth.uid;
    }
    
    /* ===========================
       SUBSCRIPTION APPROVALS
       =========================== */
    
    match /subscriptionApprovals/{approvalId} {
      // Parents and children can read their own approvals
      allow read: if isAuthenticated() && 
        (resource.data.childId == request.auth.uid || 
         request.auth.uid in resource.data.parentIds);
      
      // Children can create approval requests
      allow create: if isAuthenticated() && 
        request.resource.data.childId == request.auth.uid;
      
      // Parents can update (approve/decline)
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.parentIds;
      
      // Admins or the child can delete expired approvals
      allow delete: if isAdmin() || 
        (isAuthenticated() && resource.data.childId == request.auth.uid);
    }
    
    /* ===========================
       DEFAULT DENY ALL
       =========================== */
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
