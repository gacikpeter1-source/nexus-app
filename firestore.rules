rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is club member
    function isClubMember(clubData) {
      return request.auth.uid in clubData.members ||
             request.auth.uid in clubData.trainers ||
             request.auth.uid in clubData.assistants ||
             clubData.ownerId == request.auth.uid ||
             clubData.createdBy == request.auth.uid;
    }
    
    // Helper function to check if user is trainer or assistant
    function isTrainerOrAssistant(clubData) {
      return request.auth.uid in clubData.trainers ||
             request.auth.uid in clubData.assistants;
    }
    
    // Users collection
      match /users/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (
          request.auth.uid == userId || 
          request.auth.token.isSuperAdmin == true ||
          request.auth.token.role == 'admin' ||
          request.auth.token.role == 'trainer' ||
          request.auth.token.role == 'assistant'
        );
      }
    
    // Clubs collection - UPDATED to allow trainers/assistants
match /clubs/{clubId} {
  // TEMPORARY - allow all authenticated users
  allow read: if isAuthenticated();
  
  allow create: if isAuthenticated();
  
  allow update: if isAuthenticated() && (
    request.auth.token.isSuperAdmin == true ||
    request.auth.token.role == 'admin' ||
    resource.data.ownerId == request.auth.uid ||
    resource.data.createdBy == request.auth.uid ||
    request.auth.uid in resource.data.trainers ||
    request.auth.uid in resource.data.assistants ||
    request.auth.uid in resource.data.members
  );
  
  allow delete: if isAuthenticated() && (
    request.auth.token.isSuperAdmin == true ||
    request.auth.token.role == 'admin' ||
    resource.data.createdBy == request.auth.uid
  );
}
    
    // Events collection
    match /events/{eventId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated();  // All can create events
      
      // Allow update for RSVPs OR event management
      allow update: if isAuthenticated();  // All users can update for RSVP
      
      allow delete: if isAuthenticated() && (
        // Admins can delete all
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin' ||
        // Event creator can delete
        request.auth.uid == resource.data.createdBy ||
        // Club owner can delete all club events
        (resource.data.clubId != null && 
        (get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.ownerId == request.auth.uid ||
          get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.createdBy == request.auth.uid)) ||
        // Trainers/assistants can delete team events
        (resource.data.teamId != null &&
        (request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.trainers ||
          request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.assistants))
      );
    }
    
    // Notification settings
    match /notificationSettings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Team notification settings (nested in clubs)
    match /clubs/{clubId}/teams/{teamId}/notificationSettings/{settingId} {
      allow read, write: if isAuthenticated() && (
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin' ||
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.trainers ||
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.assistants
      );
    }

    // Club notification settings (nested in clubs)
    match /clubs/{clubId}/notificationSettings/{settingId} {
      allow read, write: if isAuthenticated() && (
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin' ||
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.trainers ||
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.assistants
      );
    }


    // ============================================================================
    // CHAT SYSTEM RULES
    // ============================================================================
    
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.members ||
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin' ||
        // Allow if user is in the club/team that this chat belongs to
        (resource.data.clubId != null && 
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.members)
      );
      
      // Create: All authenticated users can create chats
      allow create: if isAuthenticated() &&
        request.auth.uid == request.resource.data.createdBy &&
        request.auth.uid in request.resource.data.members;
      
      // Update: Members can update (add/remove members), creator has full control
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.members ||
        request.auth.uid == resource.data.createdBy ||
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin' ||
        // Club owner can manage club chats
        (resource.data.clubId != null &&
        (get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.ownerId == request.auth.uid ||
          get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.createdBy == request.auth.uid)) ||
        // Trainers/assistants can manage team chats
        (resource.data.teamId != null &&
        (request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.trainers ||
          request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.assistants))
      );
      
      // Delete: Only creator, club owner, or admin can delete
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.createdBy ||
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin' ||
        // Club owner can delete club chats
        (resource.data.clubId != null &&
        (get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.ownerId == request.auth.uid ||
          get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.createdBy == request.auth.uid))
      );
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read, create, update: if isAuthenticated();  // If they can read the parent chat, they can access messages
        allow delete: if isAuthenticated() && request.auth.uid == resource.data.senderId;
      }
    }
    
    // Subscriptions collection
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isAdmin()
      );
      
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // Order templates
    match /orderTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin' ||
        request.auth.uid == resource.data.createdBy
      );
    }

    // Order responses
    match /orderResponses/{responseId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Attendance
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        (resource.data.createdBy == request.auth.uid || isAdmin());
    }

    // After attendance section, add:
    match /clubSubscriptions/{subscriptionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin'
      );
    }
    
    // Request to join Clubs & team - UPDATED to allow trainers/assistants
    match /requests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isAdmin() ||
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.trainers ||
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.assistants
      );
    }


    // Vouchers
    match /vouchers/{voucherId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin'
      );
      allow update: if isAuthenticated();  // All users can redeem
      allow delete: if isAuthenticated() && (
        request.auth.token.isSuperAdmin == true ||
        request.auth.token.role == 'admin'
      );
    }
  }
